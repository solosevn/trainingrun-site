<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Mission Control — trainingrun.ai</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0a0f;
      --surface:   #12121a;
      --border:    #1e1e2e;
      --green:     #00e676;
      --red:       #ff1744;
      --orange:    #ff9100;
      --gray:      #444466;
      --blue:      #448aff;
      --text:      #e0e0ff;
      --subtext:   #8888aa;
      --card-bg:   #16161f;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      min-height: 100vh;
      padding: 0 0 40px 0;
    }

    /* ── HEADER ── */
    .header {
      background: linear-gradient(135deg, #0d0d1a 0%, #12122a 100%);
      border-bottom: 1px solid var(--border);
      padding: 20px 20px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .site-name {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--subtext);
    }
    .refresh-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--subtext);
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .refresh-btn:active { background: var(--border); }
    h1 {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text);
    }
    h1 span {
      color: var(--blue);
    }
    .last-updated {
      font-size: 11px;
      color: var(--subtext);
      margin-top: 4px;
    }
    .pulse-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      margin-right: 5px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    /* ── SUMMARY BAR ── */
    .summary-bar {
      display: flex;
      gap: 0;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .summary-item {
      flex: 1;
      text-align: center;
    }
    .summary-item + .summary-item {
      border-left: 1px solid var(--border);
    }
    .summary-num {
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }
    .summary-label {
      font-size: 10px;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 3px;
    }

    /* ── AGENT CARDS ── */
    .section-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--subtext);
      padding: 20px 20px 10px;
    }

    .cards {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    .card:active { transform: scale(0.98); }
    .card.expanded { border-color: var(--blue); }

    .card-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      gap: 12px;
    }

    .agent-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      background: var(--border);
    }
    .agent-icon.success { background: rgba(0,230,118,0.12); }
    .agent-icon.failed  { background: rgba(255,23,68,0.12); }
    .agent-icon.disabled{ background: rgba(68,68,102,0.3); }

    .card-info { flex: 1; min-width: 0; }
    .card-name {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.2px;
    }
    .card-label {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 2px;
    }

    .card-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
      flex-shrink: 0;
    }

    .status-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 20px;
    }
    .status-badge.success  { background: rgba(0,230,118,0.15); color: var(--green); }
    .status-badge.failed   { background: rgba(255,23,68,0.15);  color: var(--red); }
    .status-badge.disabled { background: rgba(68,68,102,0.3);   color: var(--gray); }
    .status-badge.running  { background: rgba(255,145,0,0.15);  color: var(--orange); }

    .card-score {
      font-size: 20px;
      font-weight: 700;
      color: var(--green);
      line-height: 1;
    }
    .card-score.dim { color: var(--gray); font-size: 14px; }

    .chevron {
      font-size: 10px;
      color: var(--subtext);
      transition: transform 0.25s;
      margin-top: 2px;
    }
    .card.expanded .chevron { transform: rotate(180deg); }

    /* ── EXPANDED DETAIL ── */
    .card-detail {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--border);
    }
    .card.expanded .card-detail { display: block; }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    .detail-item {
      background: var(--surface);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .detail-item.full { grid-column: 1 / -1; }
    .detail-val {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.1;
    }
    .detail-val.green { color: var(--green); }
    .detail-val.orange { color: var(--orange); }
    .detail-val.dim   { color: var(--subtext); }
    .detail-key {
      font-size: 10px;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 3px;
    }

    .sources-bar {
      margin-top: 10px;
      background: var(--surface);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .sources-bar-label {
      font-size: 10px;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .bar-track {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), var(--blue));
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .bar-fill.dim { background: var(--gray); }
    .sources-text {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 5px;
    }

    .top5-section {
      margin-top: 10px;
      background: var(--surface);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .top5-title {
      font-size: 10px;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .top5-row {
      display: flex;
      align-items: center;
      padding: 5px 0;
      gap: 10px;
    }
    .top5-row + .top5-row {
      border-top: 1px solid var(--border);
    }
    .top5-rank {
      width: 18px;
      font-size: 11px;
      font-weight: 700;
      color: var(--subtext);
      flex-shrink: 0;
    }
    .top5-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .top5-score {
      font-size: 13px;
      font-weight: 700;
      color: var(--green);
      flex-shrink: 0;
    }

    .next-run-row {
      margin-top: 10px;
      background: var(--surface);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .next-run-icon { font-size: 16px; }
    .next-run-text { font-size: 13px; color: var(--subtext); }
    .next-run-time { font-size: 13px; font-weight: 600; color: var(--text); }

    .view-leaderboard {
      display: block;
      margin-top: 10px;
      text-align: center;
      background: rgba(68, 138, 255, 0.1);
      border: 1px solid rgba(68, 138, 255, 0.3);
      color: var(--blue);
      text-decoration: none;
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.2s;
    }
    .view-leaderboard:active { background: rgba(68,138,255,0.2); }

    /* ── ERROR STATE ── */
    .error-msg {
      background: rgba(255,23,68,0.08);
      border: 1px solid rgba(255,23,68,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--red);
    }

    /* ── FOOTER ── */
    .footer {
      text-align: center;
      padding: 30px 20px 0;
      font-size: 11px;
      color: var(--subtext);
    }
    .footer a { color: var(--blue); text-decoration: none; }

    /* ── LOADING ── */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--subtext);
      font-size: 14px;
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <span class="site-name">trainingrun.ai</span>
    <button class="refresh-btn" onclick="loadStatus()">↻ Refresh</button>
  </div>
  <h1>Mission <span>Control</span></h1>
  <div class="last-updated" id="last-updated">
    <span class="pulse-dot"></span>Loading…
  </div>
</div>

<div class="summary-bar" id="summary-bar" style="display:none">
  <div class="summary-item">
    <div class="summary-num" id="sum-live" style="color:var(--green)">—</div>
    <div class="summary-label">Live</div>
  </div>
  <div class="summary-item">
    <div class="summary-num" id="sum-off" style="color:var(--gray)">—</div>
    <div class="summary-label">Off</div>
  </div>
  <div class="summary-item">
    <div class="summary-num" id="sum-today" style="color:var(--blue)">—</div>
    <div class="summary-label">Ran Today</div>
  </div>
  <div class="summary-item">
    <div class="summary-num" id="sum-errors" style="color:var(--red)">—</div>
    <div class="summary-label">Errors</div>
  </div>
</div>

<div id="main-content">
  <div class="loading">
    <div class="spinner"></div>
    Loading agent status…
  </div>
</div>

<div class="footer">
  <a href="/">← trainingrun.ai</a> &nbsp;·&nbsp; Auto-refreshes every 60s
</div>

<script>
const AGENT_ORDER = ["trscode", "trs", "trfcast", "truscore", "tragents"];

function formatTime(isoStr) {
  if (!isoStr) return "Never";
  const d = new Date(isoStr);
  const now = new Date();
  const diffMs = now - d;
  const diffH = diffMs / 3600000;
  if (diffH < 1)   return `${Math.round(diffMs/60000)}m ago`;
  if (diffH < 24)  return `${Math.round(diffH)}h ago`;
  if (diffH < 48)  return "Yesterday";
  return d.toLocaleDateString("en-US", {month:"short", day:"numeric"});
}

function formatNextRun(isoStr) {
  if (!isoStr) return "Not scheduled";
  const d = new Date(isoStr);
  const now = new Date();
  const diffMs = d - now;
  if (diffMs < 0) return "Overdue";
  const diffH = diffMs / 3600000;
  if (diffH < 1)  return `In ${Math.round(diffMs/60000)}m`;
  if (diffH < 24) return `In ${Math.round(diffH)}h (${d.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})})`;
  return d.toLocaleDateString("en-US",{weekday:"short",hour:"numeric",minute:"2-digit"});
}

function formatDuration(sec) {
  if (!sec) return "—";
  if (sec < 60) return `${sec}s`;
  return `${Math.floor(sec/60)}m ${sec%60}s`;
}

function isToday(dateStr) {
  if (!dateStr) return false;
  const today = new Date().toISOString().slice(0,10);
  return dateStr === today;
}

function renderCard(id, agent) {
  const statusClass = agent.status || "disabled";
  const iconClass   = statusClass;
  const ranToday    = isToday(agent.last_run_date);
  const srcPct      = agent.sources_total && agent.sources_hit != null
                        ? Math.round((agent.sources_hit / agent.sources_total) * 100)
                        : 0;

  let scoreHTML = "";
  if (agent.status === "success" && agent.top_score != null) {
    scoreHTML = `<div class="card-score">${agent.top_score.toFixed(1)}</div>`;
  } else if (agent.status === "disabled") {
    scoreHTML = `<div class="card-score dim">OFF</div>`;
  } else {
    scoreHTML = `<div class="card-score dim">—</div>`;
  }

  let statusLabel = agent.status === "success"  ? "LIVE"
                  : agent.status === "failed"   ? "ERROR"
                  : agent.status === "running"  ? "RUNNING"
                  : "OFF";

  let top5HTML = "";
  if (agent.top5 && agent.top5.length > 0) {
    top5HTML = `
      <div class="top5-section">
        <div class="top5-title">Top Models — ${agent.last_run_date || "Last Run"}</div>
        ${agent.top5.map(m => `
          <div class="top5-row">
            <span class="top5-rank">${m.rank}</span>
            <span class="top5-name">${m.name}</span>
            <span class="top5-score">${m.score.toFixed(1)}</span>
          </div>
        `).join("")}
      </div>`;
  }

  let errorHTML = "";
  if (agent.error) {
    errorHTML = `<div class="error-msg">⚠️ ${agent.error}</div>`;
  }

  let nextRunHTML = "";
  if (agent.enabled && agent.next_run) {
    nextRunHTML = `
      <div class="next-run-row">
        <span class="next-run-icon">⏰</span>
        <span class="next-run-text">Next run:</span>
        <span class="next-run-time">${formatNextRun(agent.next_run)}</span>
      </div>`;
  }

  return `
    <div class="card" id="card-${id}" onclick="toggleCard('${id}')">
      <div class="card-header">
        <div class="agent-icon ${iconClass}">${agent.emoji}</div>
        <div class="card-info">
          <div class="card-name">${agent.name}</div>
          <div class="card-label">${agent.label}</div>
        </div>
        <div class="card-right">
          <span class="status-badge ${statusClass}">${statusLabel}</span>
          ${scoreHTML}
          <span class="chevron">▼</span>
        </div>
      </div>
      <div class="card-detail">
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-val ${agent.last_run ? 'green' : 'dim'}">${formatTime(agent.last_run)}</div>
            <div class="detail-key">Last Heartbeat</div>
          </div>
          <div class="detail-item">
            <div class="detail-val ${ranToday ? 'green' : 'dim'}">${ranToday ? "✓ Today" : (agent.last_run_date || "Never")}</div>
            <div class="detail-key">Last Run Date</div>
          </div>
          <div class="detail-item">
            <div class="detail-val">${agent.models_qualified != null ? agent.models_qualified : "—"}</div>
            <div class="detail-key">Models Scored</div>
          </div>
          <div class="detail-item">
            <div class="detail-val ${agent.duration_seconds ? 'orange' : 'dim'}">${formatDuration(agent.duration_seconds)}</div>
            <div class="detail-key">Run Duration</div>
          </div>
        </div>

        ${agent.sources_total ? `
        <div class="sources-bar">
          <div class="sources-bar-label">Sources Hit</div>
          <div class="bar-track">
            <div class="bar-fill ${agent.sources_hit == null ? 'dim' : ''}"
                 style="width:${srcPct}%"></div>
          </div>
          <div class="sources-text">${agent.sources_hit != null ? agent.sources_hit : 0} of ${agent.sources_total} sources returned data</div>
        </div>` : ""}

        ${top5HTML}
        ${nextRunHTML}
        ${errorHTML}

        <a class="view-leaderboard" href="${agent.leaderboard_url}">
          View ${agent.label} →
        </a>
      </div>
    </div>`;
}

function toggleCard(id) {
  const card = document.getElementById("card-" + id);
  card.classList.toggle("expanded");
}

async function loadStatus() {
  try {
    const res  = await fetch("/status.json?t=" + Date.now());
    const data = await res.json();

    // Update header
    document.getElementById("last-updated").innerHTML =
      `<span class="pulse-dot"></span>Updated ${formatTime(data.last_updated)}`;

    // Summary counts
    const agents = data.agents;
    const vals   = Object.values(agents);
    const live   = vals.filter(a => a.status === "success").length;
    const off    = vals.filter(a => a.status === "disabled").length;
    const today  = vals.filter(a => isToday(a.last_run_date)).length;
    const errors = vals.filter(a => a.status === "failed").length;

    document.getElementById("sum-live").textContent   = live;
    document.getElementById("sum-off").textContent    = off;
    document.getElementById("sum-today").textContent  = today;
    document.getElementById("sum-errors").textContent = errors;
    document.getElementById("summary-bar").style.display = "";

    // Render cards (preserve expanded state)
    const expanded = new Set(
      [...document.querySelectorAll(".card.expanded")]
        .map(c => c.id.replace("card-", ""))
    );

    const html = AGENT_ORDER.map(id => {
      const agent = agents[id];
      return agent ? renderCard(id, agent) : "";
    }).join("");

    document.getElementById("main-content").innerHTML =
      `<div class="section-label">Agents</div><div class="cards">${html}</div>`;

    // Restore expanded state
    expanded.forEach(id => {
      const card = document.getElementById("card-" + id);
      if (card) card.classList.add("expanded");
    });

  } catch (e) {
    document.getElementById("main-content").innerHTML =
      `<div class="loading" style="color:var(--red)">
        ⚠️ Could not load status.json<br>
        <small style="color:var(--subtext);margin-top:8px;display:block">${e.message}</small>
      </div>`;
  }
}

// Load on start, then auto-refresh every 60s
loadStatus();
setInterval(loadStatus, 60000);
</script>
</body>
</html>
